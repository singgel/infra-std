# 简介

CDN **(content delivery/distribution network)** 内容分发网络，是由代理服务器及其数据中心组成的地理分布网络。目标是通过相对于最终用户在空间上分布服务来提供高可用性和性能。CDN 是涵盖不同类型的内容交付服务的统称，包括视频流、软件下载、web等内容。

CDN 是一个高度分散的服务器平台，可通过缩短服务器与用户之间的物理距离最大限度减少加载网页内容时出现的延迟。这有助于全球用户只需较短的加载时间即可查看相同高品质的内容。

如果没有 CDN，内容源站服务器必须对每个最终用户请求作出响应。这一机制导致原始和随后加载的流量大幅增加，因此，如果出现极高的流量峰值或持续负载，源站出现故障的机率会增大。

CDN 在源站及接近最终用户的物理和网络位置，对最终用户的请求作出响应，从而分载内容服务器的流量，改善 Web 体验，让内容提供商及最终用户均从中获益。

# 功能

**降低时延**

解决因分布、带宽、服务器性能带来的访问延迟问题，适用于站点加速、点播、直播等场景。使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度和成功率。同等情况下，响应速度与成功率提升时，用户留存等会有明显提升

**全网覆盖**

互联不互通、区域 ISP 地域局限、出口带宽受限制等种种因素都造成了网站的区域性无法访问。CDN加速可以覆盖全球的线路，通过和运营商合作，部署 IDC 资源，在全国骨干节点商，合理部署 CDN 边缘分发存储节点，充分利用带宽资源，平衡源站流量

**网络安全**

CDN 的负载均衡和分布式存储技术，可以加强网站的可靠性，能够应对绝大部分的互联网攻击事件，防攻击系统也能避免网站遭到恶意攻击

**节约成本**

使用 CDN 加速可以实现网站的全国铺设，服务器之间镜像同步，节省了人力、精力和财力。

**容灾**

当某个服务器发生意外故障时，系统将调用其他临近的健康节点进行服务

暂时无法在文档外展示此内容

假设通过CDN加速的域名为 www.byte.com ，接入CDN网络，开始使用加速服务后，当终端用户（北京）发起HTTP请求时，处理流程如下：

1.  当终端用户（北京）向下的指定资源发起请求时，首先向LDNS（Local DNS）发起域名解析请求。
1.  LDNS检查缓存中是否有 www.byte.com 的IP地址记录。如果有，则直接返回给终端用户；如果没有，则向授权DNS查询。
1.  当授权 DNS 解析 www.byte.com 时，返回域名CNAME www.tt.com 对应IP地址。
1.  域名解析请求发送至 DNS 调度系统，并为请求分配最佳节点 IP 地址。
1.  LDNS 获取 DNS 返回的解析 IP 地址。
1.  用户获取解析 IP 地址。
1.  用户向获取的 IP 地址发起对该资源的访问请求
1.  返回用户请求获得的内容

在请求打到边缘节点（如图中北京节点）时，如果该节点已缓存用户所需资源，那么节点直接将资源返回；若资源不存在，则将请求发送到源站，在获取到资源后，返回给用户并将资源缓存到节点中。
# CDN 网络架构

CDN 网络架构主要有两部分组成：中心节点、边缘节点。其中中心节点由 CDN 网管中心与 DNS 重定向解析中心组成，负责全局负载均衡；边缘节点是 CDN 分发的载体，由 Cache 与 负载均衡器组成。

**中心节点**

当用户访问加入 CDN 服务的网站时，全局负载均衡 DNS 负责域名解析，通过一组预先定义好的策略将与用户最相近的节点 IP 地址提供给用户，用户通过这个 IP 进行资源的请求。同时，全局负载均衡 DNS 还与全球 CDN 节点保持通信，确保请求可以分配到可用的节点（起到了负载均衡的作用）。

**CDN 节点**

每个CDN节点由两部分组成：负载均衡设备和高速缓存服务器。

负载均衡设备负责每个节点中各个 Cache 的负载均衡，保证节点的工作效率；同时，负载均衡设备还负责收集节点与周围环境的信息，保持与全局负载DNS的通信，实现整个系统的负载均衡。高速缓存服务器（Cache）负责存储客户网站的大量信息，就像一个靠近用户的网站服务器一样响应本地用户的访问请求。

理论上，最简单的CDN网络有一个负责全局负载均衡的DNS和各节点一台 Cache，即可运行。DNS 支持根据用户源 IP 地址解析不同的 IP ，实现就近访问。为了保证高可用性等，需要监视各节点的流量、健康状况等。

# 关键技术

**内容路由**

CDN 首先需要的是能够将用户的请求正确地打到距离用户最近的边缘节点上，这就需要做好请求的重定向问题，CDN 负载均衡系统实现的就是这一功能。

CDN 负载均衡系统将用户的请求导向整个 CDN 网络中的最佳节点（距离用户最近、节点负载最轻等），是整个 CDN 的核心，它的准确性和效率绝对了 CDN的性能和效率。

通常可以将负载均衡系统分为两个层次，全局负载均衡和本地负载均衡。在从用户请求发起到最终请求到 CDN 节点过程中，请求从整个网络范围定向到最近的区域主要由全局负载均衡负载；定向到最近区域后，需要将请求打到最合适的 CDN 节点，这个步骤就是本地负载均衡进行控制。在整个过程中，CDN 节点的负载情况、健康状况以及支持的媒体格式等运行状态都是本地负责均衡进行监测并据此进行均衡的决策。

全局负载均衡可以使用静态配置或动态监测的方式来进行负载均衡。静态配置为使用 IP 地址配置表进行映射，动态监测为探测目标 IP 与CDN 节点的距离进行负载均衡。

本地负载均衡执行决策时，会实时获取 Cache 的运行状态，之后会根据各 Cache 运行状态去进行 Cache 的选择。获取 Cache 状态的方式有2种，分别为主动探测（ping等命令）与协议交互。

**内容分发技术**

当源站资源新增或发生变更时，需要同步到 CDN 的 Cache 中，这个过程目前有两种实现方式，分别为 Pull 和 Push 方式。

Push 方式是一种主动分发的方式，将内容从源站分发到各Cache 节点，分发协议采用 HTTP/FTP 等。通过 Push 方式进行分发的内容一般都是高热的内容。

Pull 方式是一种被动分发的方式，一般是用户在请求到边缘 Cache 是发现资源不存在时，会主动从源站拉取资源，将资源返回给用户并保存到 Cache 中

在内容分发的过程中，对于Cache设备而言，关键的是需要建立内容源URL、内容发布的URL、用户访问的URL，以及内容在Cache中存储的位置之间的映射关系。

**内容存储技术**

不考虑内容源存储，只讨论 Cache 节点的存储，需要考虑功能与性能两个方面的内容：在功能上对各种内容格式的支持、对部分缓存的支持；在性能上包括容量大小、吞吐率、可靠性与稳定性。

功能上，多种内容格式特别是流媒体文件的支持，需要存储系统对不同格式的读写进行优化；部分缓存能力指流媒体可以不完整地存储或读取，可以大大提高空间利用率。

**内容管理技术**

内容管理主要为 Cache 内的内容管理，主要是为了提高内容服务的效率与提高存储利用率。主要包括本地内容索引，本地内容拷贝与本地内容访问状态信息收集。内容索引包括各 Cache 上内容名称、URL、更新时间等；内容拷贝是在某个 Cache 不足以保证对内容分发性能保证时，将该内容拷贝到 CDN 其他 Cache 节点上。

通过本地内容管理，可以将内容的管理从原来的Cache设备一级，提高到CDN节点一级，从而大大增加了CDN的可扩展性和综合能力。
# 负载均衡

**负载均衡实现**

负载均衡的作用是将请求均匀分配到各个节点，是一种动态均衡。负载均衡通过一些工具实时分析数据包，掌握网络中的数据流量状态，根据处理逻辑将请求分发出去。

目前，复杂均衡使用的策略有轮循、最小连接数、快速响应和 IP 哈希等，其中轮循即为将请求依次分配给集群中的节点；最小连接数是在每一服务器设置一个计数器，系统选择将请求分配到计数器值最小的服务器上；快速响应是根据集群中节点的状态来分配任务；IP 哈希是将每一个请求哈希到各个节点。

基于这些负载均衡算法，负载均衡实现方式包括 DNS 轮循，反向代理服务器与地址转换网关。

DNS 负载均衡是在 DNS 中为多个地址配置同一个名字，当查询该 URL 时会得到其中一个地址进行访问。它是一种简单有效的负载均衡方式，但不能区分服务器的差异以及无法反映服务器的运行状态，同时，由于 DNS 数据具有刷新时间标识，为了 DNS 解析到的地址能够随机分配给用户的请求，需要尽量降低刷新时间，但刷新时间过短又会造成 DNS 流量大增，造成额外网络问题。另外 DNS 负载均衡由于刷新时间这一特性，当服务器发生故障时不能及时探测并切流。

⽀持负载均衡的地址转换⽹关，可以将⼀个外部IP地址映射为多个内部IP地址，对每次TCP连接请求动态使⽤其中⼀个内部地址，达到负载均衡的⽬的。⼀般采⽤随机选择、根据服务器的连接数量或者响应时间进⾏选择的负载均衡策略来分配负载

**GSLB**

GSLB(Global Server Load Balancing，全局负载均衡)，是 CDN 中负责解析 CNAME 并给出集群地址的负载均衡器，是基于 DNS 的负载均衡。在基于 DNS 方式的负载均衡下，请求始终会有一部分无法到达 GSLB，原因是 DNS 本身的缓存机制。在缓存机制的帮助下，很大一部分的用户请求无法打到 GSLB，从而减轻了 GSLB 的处理压力。但是，由于使用 DNS 进行处理，当出现单点故障时无法进行识别，导致用户请求可能会发送到故障节点。

为了实现智能调度，基于 DNS 的 GSLB 设备附近会以旁路的方式部署一台辅助设置(全局资源管理设备)，用以实现与各边炉节点的本地资源管理设备进行通信，实现 CDN 对各边缘节点的状态检查，并根据节点的状态，重新指定用户调度策略。

同时，DNS 服务是以 UDP 为基础的、默认无连接的访问方式，这给分布式攻击带来了很大便利。这种情况下，隐藏节点可以很大程度上避免出现 GSLB 出现被攻击瘫痪的情况，该隐藏节点是一台备份的 GSLB 设备并被隐藏。

GSLB 除去使用 DNS 解析外，还可以使用 HTTP 重定向的方式来进行负载均衡。 HTTP 重定向只适用于 HTTP 应用，并且重定向过程需要额外解析域名 URL 以及与 URL 建立 TCP 连接并发送请求，使得响应时间加长。另外，HTTP 重定向会使得所以请求都发送到 GSLB 系统，使得性能与可靠性成为一个问题。

| ⽐较项 | 基于DNS解析⽅式                           | 基于HTTP重定向⽅式                   | 基于IP路由⽅式                   |
| --- | ----------------------------------- | ----------------------------- | -------------------------- |
| 性能  | 本地DNS服务器和⽤户终端DNS缓存能⼒使GSLB的负载得到有效分担  | GSLB处理压⼒⼤，容易成为系统性能的瓶颈         | 借助IP⽹络设备完成负载均衡，没有单点性能瓶颈    |
| 准确度 | 定位准确度取决于本地DNS覆盖范围，本地DNS设置错误会造成定位不准确 | 在对⽤户IP地址数据进⾏有效维护的前提下，定位准确且精度⾼ | 就近性调度准确，但对设备健康性等动态信息响应会有延迟 |
| 效率  | 效率约等于DNS系统本身处理效率                    | 依靠服务器做处理，对硬件资源的要求⾼            | 效率约等于IP设备本身效率              |
| 扩展性 | 扩展性和通⽤性好                            | 扩展性较差，需对各种应⽤协议进⾏定制开发          | 通⽤性好，但适⽤范围有限               |
| 商⽤性 | 在Web加速领域使⽤较多                        | 国内流媒体CDN应⽤较多                  | 尚⽆商⽤案例                     |

# 流媒体 CDN

流媒体业务是⼀种对实时性、连续性、时序性要求⾮常⾼的业务，⽆论从带宽消耗上还是质量保障上来说，对 best-effort 的 IP ⽹络都是⼀个不⼩的冲击。在点播、直播中，常用的互联网协议包括RTMP、RTSP、HTTP 协议，

RTP、RTCP、RTSP、RTMP 的关系：RTSP 协议⽤来实现远程播放控制，RTP ⽤来提供时间信息和实现流同步，RTCP协助RTP完成传输，RTMP 和 HTTP streaming 则是将流同步、播放控制、质量控制集成起来的企业⾃有流媒体传送协议

> RTP(Real-time Transport Protocol)是用于Internet上针对多媒体数据流的一种传输协议。RTP被定义为在一对一或一对多的传输情况下工作。其目的是提供时间信息和 实现流同步。但RTP通常使用UDP来传送数据。但RTP也可以在TCP或ATM等其他协议之上工作。当应用程序开始一个RTP会话时将使用两个端口:一 个给RTP一个给 RTCP。RTP本身并不能为接顺序传送数据包提供可靠的传送机制。也不提供流量控制或拥塞控制。它依靠RTCP提供这些服务。通常RTP算法并不作为一 个独立的网络层来实现。而是作为应用程序代码的一部分。实时传送控制协议RTCP.

> RTCP(Real-time Transport Control Protocol)和RTP提供流量控制和拥塞控制。在RTP会话期间,各参与者周期性地传送RTCP包.RTCP包中含有已发送的数据包的数量、丢失的 数据包的数量等统计资料.因此,服务器可以利用这些信息动态地改变传输速率，甚至改变有效载荷类型。RTP和RTCP配合使用，它们能以有效的反馈和最小 的开销使传输效率最佳化。因而特别适合传送网上的实时数据。

RTSP实时流协议RTSP(Real-time Streaming Protocol)是由Real Networks和Netscape共同中提出的。该协议定义了一对多应用程序如何有效地通过lP网络传送多媒体数据。**RTSP在体系结构上位于RTP和 RTCP之上。它使用TCP或RTP完成数据传输。HTTP与RTSP相比。HTTP传送HTML。而RTP传送是多媒体数据。HTTP请求由客户机发出，服务器作出响应；使用RTSP时，客户机和服务器都可以发出请求，即RTSP可以是双向的。**

RTSP/RTP 和 HTTP streaming 是⽬前应⽤最⼴泛的流化协议，⽬前电信运营商在IPTV（特殊通道的基于IP的流媒体播放）的流化上主要以 RTSP/RTP 技术为主，互联⽹视频⽹站（点播/直播）多倾向于使⽤HTTP streaming 的流化技术。

HTTP streaming⾸先会将视频数据在服务器上进⾏编码，然后将编码后的数据进⾏更细粒度的分⽚，再把每个分⽚通过 HTTP协议传输到客户端。HTTP streaming 的客户端需要对视频⽂件的每个分⽚都发出⼀个 HTTP 请求，这样，在视频播放速度低于下载速度的情况下，客户端可以灵活控制 HTTP 请 求的发出速度，从⽽保证⽤户在中途退出时不会出现下载浪费。另外，因为采⽤分⽚的特点，HTTP streaming还可以实现媒体播放过程中的码率切换（码率⾃适应），结合⽹络带宽资源，为⽤户提供更好的体验。

流媒体加速的回源要求：因为流媒体⽂件传送带宽需求⾼，⽽且往往需要维持 TCP ⻓连接，所以⼀旦CDN 回源⽐例过⾼，源站服务器 I/O 将不堪负荷。

在流媒体CDN系统中，⽤户访问的调度会更多考虑内容命中，主要是因为流媒体内容⽂件体积⼤，业务质量要求⾼，如果从其他节点拉内容再向⽤户提供服务会带来额外的延迟，影响⽤户体验。为进⼀步提⾼命中率，流媒体CDN系统普遍采⽤了对热点内容实施预先push的内容分发策略

| 流媒体CDN与Web CDN的对⽐（业务差异）主要差异点 | 流媒体CDN                     | Web CDN                        |
| ---------------------------- | -------------------------- | ------------------------------ |
| 内容类型                         | ⼤⽂件、实时流、QoS要求⾼             | ⼩⽂件、固定⼤⼩、QoS要求低                |
| ⽤户⾏为                         | 拖曳、暂停等播放控制                 | 下载后浏览                          |
| 内容管理                         | 内容冷热度差异明显（对命中率要求⾼），内容⽣命周期⻓ | 内容冷热度差异不明显，内容⽣命周期短             |
| 回源要求                         | 回源⽐例⼩                      | 回源⽐例⼤                          |
| 主要差异点                        | 流媒体CDN                     | Web CDN                        |
| Cache                        | ⽀持多种流化协议，硬件配置⼤存储、⾼I/O      | ⽀持多协议（HTTP、FTP等）硬件配置⼩存储、⾼性能CPU |
| 负载均衡                         | DNS+HTTP重定向⽅式              | DNS⽅式                          |
| 内容分发⽅式                       | 热⽚PUSH，冷⽚PULL              | 全PULL⽅式                        |
| 组⽹                           | 多级组⽹，可能要求组播、单播混合组⽹         | 两级组⽹                           |

对使⽤CDN服务的SP来说，CDN的作⽤在于尽量就近为⽤户提供服务，帮助SP解决⻓距离IP传输和跨域传输带来的种种业务质量问题（通过空间换取时间）。而由于距离用户最近性能最好但成本较高，提供服务的 Cache 设备需要根据需要从源站或其他 Cache 获取内容，从而形成 CDN 分层部署。

从⽹络分层上看，Web CDN通常是两级架构，即中⼼-边缘。⽽流媒体CDN通常有三级以上架构，即中⼼-区域-边缘。根本原因是流媒体回源成本较高，特别是直播业务中，如果没有二层节点中继，中心节点压力会非常大

在直播业务中，边缘Cache从区域中⼼获取直播流，⽽不需要直接向中⼼节点（源站）获取，从⽽节省了区域中⼼到中⼼节点这⼀段的⼤部分带宽。因为直播流在各个Cache中都不需要占⽤很⼤的存储空间，只需少量缓存空间即可，所以直播业务⽅⾯并不⽤注重考虑存储成本

# 动态加速

静态内容的加速，都是对于表现层的加速，对于动态⻚⾯等内容的加速，则要涉及逻辑层和数据访问层的加速技术。动态内容的提供不仅仅是 HTML ⻚⾯的设计及编辑，它还需要有后台数据库、应⽤逻辑程序的⽀持，以实现与⽤户的动态交互。

Web ⽹站借助 CDN 技术能够获得更好的扩展性和⾼性能，核⼼在于 CDN 采⽤的缓存(caching)和复制(replication)机制，其中缓存是将最近经常被访问的源服务器拥有的内容复制到边缘服务器上，可被视为具有特定策略的复制。CDN 的复制机制是指将源 Web 系统逻辑架构的各个层次的相应功⽤复制到边缘服务器上实现，以缓解源系统的处理压⼒。

-   Web系统表现层的复制，就是静态内容的复制。边缘服务器⼜被称为代理服务器，通过反向代理加速静态⽂件的交付
-   Web系统业务逻辑层的复制。CDN 被⽤于改进动态⽣成内容的交付性能。即将应⽤程序和业务组件直接在 CDN 的边缘服务器中计算，从⽽直接在靠近⽤户的地⽅⽣成动态Web内容
-   Web 系统数据访问层复制。CDN 边缘服务器能够具备⽣成动态内容和掌管内容⽣成数据的能⼒
-   Web系统⽤户⽂件的复制。

# 优化案例

> 本节为手淘双11 图片 CDN 优化

手淘图片采用 img-picsasso 处理图片，处理时会依据商品图片与详情等内容进行组合得出图片。在双11大促时，店家对商品进行改价等情况可能会在同一时段内大批量发生，导致商品请求图片时 url 发生变化，请求到 CDN 会发生无缓存内容，将请求打到源站的情况，会对源站造成巨大压力。

**用户访问图片过程**

-   用户通过手机淘宝来搜索商品或者查看宝贝详情。
-   详情/搜索/推荐通过调用商品中心返回商品的图片URL。
-   客户端本地如果有该图片的缓存，则直接渲染图片，否则执行下一步。
-   从CDN L1回源图片，如果L1有该图片的缓存，则客户端渲染图片，同时缓存到本地，如果L1没有缓存，则执行下一步。
-   从CDN L2回源图片，如果L2有该图片的缓存，则客户端渲染图片，同时CDN L1及客户端缓存图片内容，如果CDN L2没有缓存该图片，则执行下一步。
-   从图片空间回源图片，图片空间会从OSS拉取图片源文件，按要求进行尺寸缩放，然后执行编解码，返回客户端能够支持的图片内容，之后客户端就可以渲染图片，同时CDN的L1、L2以及客户端都会缓存图片内容。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb2290f962f8489e8430045e3ffcb9b0~tplv-k3u1fbpfcp-zoom-1.image)

当商品详情发生变化时，用户读取商品图片时，CDN 及手机淘宝原本缓存的图片内容失效了，用户访问图片会全部回源到img-picasso

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d2d4e31a27bc4ee69df1311b29b6c0ef~tplv-k3u1fbpfcp-zoom-1.image)

解决这2个问题，对应的有2个办法：

（1）改图保持图片URL不变，可以避免商品链路的缓存失效。

（2）在访问高峰到来之前，提前预热图片到CDN，可以避免CDN缓存失效对源站的压力。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c91529639d74ba287031b807b43047f~tplv-k3u1fbpfcp-zoom-1.image)

**OSS 三地同步**

淘宝的图片空间，承载了淘系所有图片的上下行稳定性保障，为了保障高可用，一份资源会存储到三地OSS。图片上传时，默认只上传一地，利用 OSS 的能力，自动同步到另外两地。

但是使用URL不变方案，CDN缓存已经清除完成后，如果另外2地的 OSS 还未同步完成，用户访问后，就会回源到旧的图片内容，发现图片内容没有变化。

针对该问题，将异步同步OSS软链的模式，改成三地同步建软链，三地都返回成功后，再去清除CDN 缓存，这就保证了用户访问的图片一定是最新的内容。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cb15f2d95e20496da656a9f82879d629~tplv-k3u1fbpfcp-zoom-1.image)

**提前预热CDN图片**

通过改图保持图片 URL 不变，解决了改图对商品链路缓存的影响。但是，图片变化时，虽然 URL 没有变，但清除了 CDN 缓存，导致用户访问时还是会回源到 img-picasso 源站，所以对图片源站的压力依然存在。此时通过预热，将图片预先存入到 CDN 中，刷新保证 CDN 存在缓存

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/50bcc0a4076f4a3e8b88209ed8edef82~tplv-k3u1fbpfcp-zoom-1.image)

# 名词介绍

**CDN**：content delivery/distribution network，内容分发网络或内容传递网络

**CNAME 记录**：CNAME即别名( Canonical Name )；可以用来把一个域名解析到另一个域名，当 DNS 系统在查询 CNAME 左面的名称的时候，都会转向 CNAME 右面的名称再进行查询，一直追踪到最后的 PTR 或 A 名称，成功查询后才会做出回应，否则失败。

**CNAME 域名**：接入 CDN 时，在 CDN 提供商控制台添加完加速域名后，会得到一个 CDN 分配的CNAME域名， 在DNS解析服务商添加 CNAME 记录，将自己的加速域名指向这个 CNAME 域名，这样该域名所有的请求才会都将转向 CDN 的节点，达到加速效果。

**DNS**：Domain Name System，域名解析服务，把域名转换成为网络可以识别的 IP 地址。

**回源 host**：回源 host 决定回源请求访问到源站上的具体某个站点

**ISP**：Internet Service Provider，互联网服务提供商

**PTR/A 记录：** 电子邮件系统中的邮件交换记录的方式，常被用于反向地址解析